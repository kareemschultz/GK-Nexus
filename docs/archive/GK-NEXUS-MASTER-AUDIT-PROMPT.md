# GK-NEXUS COMPREHENSIVE AUDIT PROMPT
## Master Prompt for Gemini CLI / Claude Code

---

## ROLE & TASK

**ACT AS:** A Senior SaaS Architect, Product Manager, Security Auditor, and Financial Software Specialist.

**TASK:** Perform a strictly READ-ONLY "Deep Dive" Audit of the entire codebase against SPECIFIC Business Requirements.

**GOAL:** Identify architectural gaps, security risks, dead code, configuration drift, compliance issues, and create a comprehensive implementation plan.

---

## GLOBAL RULES FOR THIS AUDIT

### 1. Read-Only Only
- Do NOT edit, format, or save any files.
- Do NOT run migrations (`db:migrate`), studio tools, or any destructive commands.
- Any shell command shown in this prompt (e.g. `npx depcheck`, `find . -name "*.md"`) is a **suggested command for a human**, not something you should execute. Instead:
  - Infer what it would reveal by reading code.
  - List it under "Recommended Commands" if useful.

### 2. Paths & Missing Files
- If a referenced path or file does not exist (e.g. `apps/server/src/index.ts`):
  - Explicitly state: `PATH NOT FOUND: apps/server/src/index.ts`.
  - Do NOT invent its contents.
- If a feature is mentioned in requirements but no related code is found, mark it as `✗` or `?` in the relevant table.

### 3. Result Markers
Use these markers consistently in all tables:
- `✓` = Implemented and appears correct.
- `✗` = Not implemented or clearly incorrect.
- `N/A` = Not applicable to this codebase.
- `?` = Unclear from code; requires manual verification.

### 4. Prioritization When Time/Context is Limited
If you cannot fully cover all phases in depth, prioritize in this order:
1. Security & compliance (PHASE 1, 4, 5, 12, 18).
2. Data model & integrity (PHASE 2, 3, 18, 19, 20, 21).
3. Mock data replacement and invoicing (PHASE 18, 2, 19, 20).
4. DevOps & environment (PHASE 10, 15, 17, 14).
5. UI/UX & documentation (PHASE 6, 7, 8, 9, 11, 14).

### 5. Severity & Priority Definitions
Use consistent severity/priority levels:
- **CRITICAL / P0** – Security risk, data loss, legal/compliance issue, or blocks production.
- **HIGH / P1** – Major feature or architecture issue that strongly affects launch quality.
- **MEDIUM / P2** – Important but not blocking production.
- **LOW / P3** – Nice-to-have improvements, refactors, polish.

### 6. Handling Uncertainty
- Never guess or hallucinate implementation details.
- When unsure, use `?` and briefly explain what evidence is missing (e.g., "API key config not found; may be injected via infrastructure").

### 7. Search Strategy
When asked to "SEARCH for …" (e.g. `KAJ`, `GCMC`, `TODO`, `console.log`):
- Use project-wide search where possible.
- Summarize results as: `File: path/to/file.ts (line ~123) — short description`.
- Group similar findings (e.g. multiple `console.log` in same file) instead of listing each line individually.

### 8. Tool Usage Constraints
You may use `git grep`, project search, and file viewing tools, but you must:
- Avoid `git commit`, `git push`, or editing files.
- Avoid running any command that writes to the DB or filesystem.
- Keep the final `AUDIT_FINDINGS.md` under 25k tokens; be concise while preserving all required sections.

### 9. Output Format
- Produce a single markdown document titled `AUDIT_FINDINGS.md`.
- Follow the exact section and table structure given in this prompt.
- It is acceptable to leave table rows in a summarized state when the table would otherwise become excessively long; do not omit required sections entirely.
- **Agent Identification:** At the top of your report, clearly state which AI agent produced it (e.g., "Generated by: CLAUDE" or "Generated by: GEMINI"). This helps when comparing reports from multiple agents.

### 10. Global UX Rule
Throughout the entire app, navigation, interactions, forms, wizards, and modals MUST be intuitive, consistent, and accessible, leveraging shadcn/ui and Tailwind as the primary design system. Flag any screen or component that feels inconsistent, confusing, inaccessible, or visually out-of-step with a modern SaaS admin experience.

### 11. Conflict Resolution Rule
If existing implementation conflicts with the stated business requirements in this prompt, **treat the business requirements as the source of truth** and flag the implementation as a gap. Do not assume the code is correct—verify against requirements.

### 12. Discovery & Deep Analysis Mandate
This audit is not just a checklist exercise. You must:
- **Understand the Current State:** What does the codebase actually do today? What works? What's broken? What's missing entirely?
- **Understand the Desired State:** Based on the business requirements (KAJ + GCMC unified platform, shared clients, cross-business invoicing), what SHOULD the codebase do?
- **Identify the Gap:** Clearly articulate the delta between current and desired states.
- **Trace User Journeys:** Mentally walk through real user scenarios and trace the code paths. Where do they break down?
- **Surface Hidden Issues:** Look beyond obvious bugs—find architectural decisions that will cause pain at scale or when adding the 3rd business unit.

---

## REPO LAYOUT ASSUMPTIONS

This prompt assumes a monorepo with:
```
/apps
  /web          # React frontend (TanStack Router)
  /server       # Hono API server
/packages
  /api          # oRPC routers
  /auth         # Better-Auth configuration
  /database     # Drizzle ORM schemas
  /ui           # Shared UI components (if exists)
/docs           # Documentation
```

**If any listed path does not exist, explicitly note `PATH NOT FOUND` in the report rather than assuming it exists or inventing code.**

---

## CRITICAL BUSINESS CONTEXT - READ FIRST

### Platform Overview

This is **GK-Nexus**, a UNIFIED BUSINESS MANAGEMENT PLATFORM for a family-owned professional services group in Guyana. 

**THIS IS NOT A MULTI-TENANT SAAS APPLICATION.**

### Platform Architecture Diagram

```
Platform: GK-Nexus (Unified Business Management)
│
├── Owner/Admin (Father-in-law)
│   └── Full access to everything
│
├── Employees (Staff members)
│   ├── Some work for KAJ only
│   ├── Some work for GCMC only
│   └── Some work for both
│
├── Business Units
│   ├── KAJ Financial Services
│   │   └── Services: Tax Returns, PAYE, NIS, Compliance Certs, Audits
│   └── GCMC (Green Crescent Management Consultancy)
│       └── Services: Training, Incorporation, Paralegal, Immigration, Proposals
│
├── Shared Clients (Critical!)
│   └── Client "ABC Ltd" might use:
│       ├── GCMC: Company Incorporation
│       ├── KAJ: Tax Registration & Returns
│       ├── GCMC: Work Permit Application (immigration side)
│       └── KAJ: Work Permit Tax Compliance
│
└── Unified Invoicing
    └── Single invoice can include:
        ├── KAJ: Income Tax Return Filing - $50,000
        ├── KAJ: NIS Registration - $15,000
        └── GCMC: Business Registration - $25,000
```

### Business Unit Details

#### KAJ Financial Services
**GRA Licensed Accountant Practice offering:**

| Category | Services |
|----------|----------|
| **Tax Filing** | Income Tax Returns, PAYE Returns |
| **Compliance Certificates** | Tender, Work Permit Tax, Land Transfer, Liability (Firearm), Pension, Certificate of Assessment |
| **Financial Statements** | Income/Expenditure, Bank Verification, Cash Flow, Loans, Investments, Commissioner of Police (Firearm) |
| **Audits** | NGO Audit, Co-operative Society Audit |
| **NIS Services** | Registration, Contribution Schedules, Compliance Certificate, Pension Queries |

#### GCMC (Green Crescent Management Consultancy)
**Business Consulting & Paralegal Services offering:**

| Category | Services |
|----------|----------|
| **Training** | HR Management, Customer Relations, Co-operatives & Credit Unions, Organisational Management |
| **Business Development** | Company Incorporation, Business Registration |
| **Paralegal** | Affidavits, Agreement of Sales & Purchases, Wills, Settlement Agreement, Separation Agreement, Investment & Partnership Agreement |
| **Immigration** | Work Permit Application, Citizenship Application, Business Visa |
| **Business Proposals** | Land Occupation, Investment, Start-up |
| **Networking/Referrals** | Real Estate Agency, IT Services, Law Firm |

### Core Business Requirements

#### 1. Shared Clients
A single client (e.g., "ABC Ltd") can use services from BOTH KAJ and GCMC:
- Example: New business needs GCMC for incorporation, KAJ for tax registration

#### 2. Service Overlap
Work Permits involve BOTH businesses:
- GCMC: Immigration application process
- KAJ: Tax compliance documentation

#### 3. Unified Invoicing
One invoice can contain line items from multiple businesses:
- Should show business unit per line item
- Combined or separated totals supported

#### 4. Employee Access Control
| Role | Access Level |
|------|-------------|
| Owner | Full access to everything |
| Admin | Full access to assigned business(es) |
| Employee | Access to assigned business(es), limited to own cases |

Employee assignments:
- Some employees work KAJ only
- Some employees work GCMC only
- Some employees work for both

#### 5. Future Expansion
Adding a new business unit should require ZERO code changes - just database insert + configuration.

### Architecture Requirements (NOT Multi-Tenant)

**DO:**
- ✓ One owner login sees all businesses
- ✓ Employees see only businesses they're assigned to
- ✓ Clients can be shared across businesses
- ✓ Invoices can span multiple businesses
- ✓ Reports can consolidate or filter by business
- ✓ Adding new business = database operation only

**DO NOT:**
- ✗ Strict data isolation between businesses
- ✗ Separate authentication per business
- ✗ Per-business subscriptions/billing

### Required Data Model

```
User
  └── Role (owner, admin, employee)
  └── AssignedBusinesses[] (which businesses they can access)

Business (KAJ, GCMC, future...)
  └── Type (tax_accounting, business_consulting, etc.)
  └── Services[]
  └── Settings (branding, defaults)

Client
  └── Businesses[] (MANY-TO-MANY - can belong to multiple!)
  └── Contacts[]
  └── Documents[]

Service
  └── BusinessId
  └── Category
  └── Pricing
  └── RequiredDocuments[]
  └── EstimatedDuration

Case/Engagement
  └── ClientId
  └── Services[] (can be from different businesses!)
  └── AssignedEmployeeId
  └── Status, Deadlines
  └── LinkedCases[] (for cross-business workflows)

Invoice
  └── ClientId
  └── LineItems[]
      └── ServiceId
      └── BusinessId (for reporting/separation)
  └── Combined and per-business subtotals

Document
  └── ClientId OR CaseId
  └── BusinessId
  └── Type, Status, ExpiryDate
```

### Tech Stack Reference

| Layer | Technology |
|-------|------------|
| Frontend | React, TanStack Router, Tailwind CSS, shadcn/ui, lucide-react |
| Backend | Hono, oRPC |
| Database | Drizzle ORM, PostgreSQL |
| Auth | Better-Auth |
| Runtime | Bun |
| Monorepo | Turborepo |

---

## AUDIT PHASES

---

### PHASE 1: AUTHENTICATION & ONBOARDING (CRITICAL)

**Audit:** `packages/auth`, `packages/database`, `apps/web/src/routes`

#### 1.1 Day 0 Setup
- INVESTIGATE: How is the first "Super Admin/Owner" created?
- Is there a seeding script?
- Is there a "Day 0" setup wizard?
- If deployed fresh, does first signup become Admin or unassigned?
- Is organization/business creation during signup or separate?

#### 1.2 User Model
- CHECK: Does the user model support assigning to multiple businesses?
  - Correct: `assignedBusinesses: ['kaj', 'gcmc']`
  - Incorrect: Single `businessId` field
- Does signup form assign roles and businesses?

#### 1.3 Missing Auth Flows
Check if these exist:
- [ ] Forgot Password / Password Reset
- [ ] Email Verification
- [ ] Invite User to Organization/Business
- [ ] User Impersonation (for admin support)
- [ ] Session Management (view/revoke active sessions)
- [ ] Account Deactivation/Deletion
- [ ] 2FA/MFA implementation status

---

### PHASE 2: BUSINESS LOGIC & DATA MODEL (CRITICAL)

**Analyze:** `packages/database/src/schema/*`, `packages/api/src/routers/*`

#### 2.1 Client-Business Relationship
- Is it MANY-TO-MANY? (Correct - one client, multiple businesses)
- Or ONE-TO-MANY? (Incorrect - client belongs to single business)

#### 2.2 Invoice Structure
- Can one invoice have line items from different businesses?
- Is there per-business subtotal support?

#### 2.3 Service Catalog
- Is it database-driven or hardcoded in code?
- Can services be added/modified without code changes?

#### 2.4 Case/Engagement Model
- Can a case include services from multiple businesses?
- Can cases be linked together (cross-business workflows)?

#### 2.5 Hardcoded Business Logic
- SEARCH for hardcoded strings: "KAJ", "GCMC", "kaj", "gcmc"
- Report all occurrences - these should be database-driven

---

### PHASE 3: DATABASE & DATA INTEGRITY

**Audit:** `packages/database/src/schema/*.ts`

#### 3.1 Schema Quality
- [ ] Are all foreign key relationships properly defined?
- [ ] Are indexes optimized for common queries (businessId, clientId, status)?
- [ ] Is there soft-delete support (deletedAt) for audit trail?
- [ ] Are DECIMAL types used for money (not FLOAT)?
- [ ] Is there created_by/updated_by tracking?
- [ ] Is there createdAt/updatedAt on all tables?

#### 3.2 Missing Tables
Check if these exist:
- [ ] invoices
- [ ] invoice_line_items
- [ ] payments
- [ ] audit_logs
- [ ] notifications
- [ ] email_templates
- [ ] businesses (dynamic, not hardcoded)
- [ ] user_businesses (many-to-many join)
- [ ] client_businesses (many-to-many join)
- [ ] cases/engagements
- [ ] case_services (many-to-many)

#### 3.3 Data Issues
- IDENTIFY tables using mock data instead of real database
- IDENTIFY orphaned schemas not exported from index
- CHECK for RLS (Row Level Security) policies

---

### PHASE 4: API SECURITY & VALIDATION (CRITICAL)

**Audit:** `packages/api/src/routers/*.ts`, `apps/server/src/index.ts`

#### 4.1 Authentication & Authorization
- [ ] Rate limiting on sensitive endpoints (login, signup, password reset)
- [ ] All endpoints check authentication (except public routes)
- [ ] All endpoints filter by user's assigned businesses
- [ ] Role-based access control implemented

#### 4.2 Input Validation
- SEARCH for `z.any()` - should NOT exist (breaks type inference)
- All inputs properly validated with Zod schemas
- File upload validation (type, size limits)

#### 4.3 Security Vulnerabilities
- [ ] Cookie security: sameSite should be "lax" not "none"
- [ ] CORS: No empty string fallbacks
- [ ] SQL injection: All queries parameterized
- [ ] Command injection: Check backup-service for shell command risks
- [ ] XSS: Check export functions for unsanitized user content
- [ ] Path traversal: Check file upload/download paths

#### 4.4 Sensitive Data
- Are passwords, tokens, API keys filtered from responses?
- Are error messages safe (no stack traces in production)?

---

### PHASE 5: GUYANA-SPECIFIC COMPLIANCE (CRITICAL)

**Audit:** `apps/web/src/lib/tax*.ts`, `packages/api/src/services/*`

#### 5.1 Tax Rate Verification (2025 Budget)
Verify against GRA (Guyana Revenue Authority) requirements:

| Tax | Rate | Threshold |
|-----|------|-----------|
| PAYE Bracket 1 | 0% | $0 - $130,000/month |
| PAYE Bracket 2 | 25% | $130,001 - $260,000/month |
| PAYE Bracket 3 | 35% | Over $260,000/month |
| VAT | 14% | Standard rate |
| NIS Employee | 5.6% | Up to $280,000/month ceiling |
| NIS Employer | 8.4% | Up to $280,000/month ceiling |

#### 5.2 Tax Configuration
- Are rates configurable by admin or hardcoded?
- Is there tax year/period support?
- Are calculations auditable (can user see how result was derived)?
- Is there historical rate support (for past years)?

#### 5.3 Missing GRA Features
- [ ] GRA e-Services integration readiness
- [ ] Tax filing deadline tracking and reminders
- [ ] Compliance certificate generation (PDF)
- [ ] NIS contribution schedule generation
- [ ] Tax return PDF generation
- [ ] GRA-formatted export files

---

### PHASE 6: UI/UX & COMPLETENESS

**Audit:** `apps/web/src/routes/*`, `apps/web/src/components/*`

#### 6.1 Missing Standard Pages
- [ ] User Profile page
- [ ] Account Settings
- [ ] Audit Logs viewer
- [ ] 404 Not Found page
- [ ] 500 Error page
- [ ] Maintenance mode page

#### 6.2 Business Filtering UI
- [ ] Is there a "Business Switcher" in the UI?
- [ ] Can user filter all lists by business (KAJ, GCMC, All)?
- [ ] Is current business context visible?

#### 6.3 Dashboard Requirements
- [ ] Combined view (all businesses)
- [ ] Per-business breakdown
- [ ] Revenue comparison between businesses
- [ ] Client overlap visibility

#### 6.4 Access Control UI
- [ ] Are admin-only links hidden from regular employees?
- [ ] Are business-restricted items hidden appropriately?
- [ ] Is there role-based menu rendering?

#### 6.5 UX Quality
- [ ] Mobile responsiveness
- [ ] Loading states on all async operations
- [ ] Error boundaries
- [ ] Empty states with CTAs ("No invoices yet - Create one")
- [ ] Confirmation dialogs for destructive actions
- [ ] Breadcrumbs for navigation
- [ ] Global search
- [ ] Form accessibility (labels, aria, keyboard nav)

#### 6.6 Broken UI Elements
- Search for `onClick={() => {}}` - empty handlers
- Search for `onClick={undefined}`
- Check if all buttons actually work

#### 6.7 Frontend Design & Implementation Standards

The frontend MUST feel modern, intuitive, and consistent with the agreed tech stack (React, Tailwind CSS, shadcn/ui, lucide icons).

**CHECK THE FOLLOWING:**

##### Navigation & Information Architecture
- Main navigation is clear, consistent, and discoverable (no "hidden" critical pages).
- Breadcrumbs or equivalent context indicators exist on deeper pages.
- Users can always see:
  - Where they are
  - How to go back
  - How to get to key areas (Dashboard, Clients, Cases, Invoices, Reports, Settings).
- Navigation patterns are consistent across KAJ, GCMC, and future business units.

##### Interactions, Forms, and Wizards
- Multi-step flows (onboarding, client creation, cases/engagements, invoices, tax workflows, etc.) use **clear, step-by-step wizards** with:
  - Step indicators
  - Back/Next controls
  - Clear validation messages
  - Ability to save and resume (if implemented).
- Each form has:
  - Proper labels
  - Inline validation errors
  - Helpful placeholders or hints **without** replacing labels.
- Complex actions (e.g. creating a case with cross-business services, big invoices) are broken into logical steps, not a single giant form.

##### Modals, Dialogs, and Confirmations
- Modals are used only for focused, short tasks and confirmations (not entire workflows).
- All destructive actions (delete client, delete case, delete document, void invoice, etc.) have:
  - Confirmation dialogs
  - Clear explanation of consequences.
- Every modal:
  - Traps focus
  - Can be closed via Escape
  - Returns focus to the triggering element.

##### Design System: Tailwind + shadcn/ui
- shadcn/ui components are used as the **primary UI building blocks** (Buttons, Inputs, Dialogs, Dropdowns, Tabs, Toasts, etc.), not ad-hoc custom components everywhere.
- Tailwind utilities follow a **consistent design language**:
  - Spacing scale (e.g. 2/4/6/8)
  - Typography hierarchy (text-sm, text-base, text-lg, etc.)
  - Border radius (e.g. `rounded-xl` / `rounded-2xl` for cards)
  - Shadow usage is consistent (no random mix of `shadow-sm`, `shadow-xl` on similar elements).
- No large blocks of inline CSS or random custom styles where a shadcn component + Tailwind would suffice.
- Icons:
  - Use lucide-react consistently.
  - Iconography is meaningful, not decorative noise.

##### Accessibility (a11y)
- All interactive elements (buttons, links, tabs, inputs, dropdowns, menu items) are:
  - Keyboard reachable (Tab / Shift+Tab).
  - Clearly visible focus state (outline, shadow, or style change).
- Forms:
  - Every input has an associated `<label>` or `aria-label`.
  - Error messages are announced appropriately (e.g. `aria-describedby`).
- Color contrast:
  - Text vs background meets WCAG AA where possible.
  - No "text on primary" combinations that are hard to read.
- ARIA usage:
  - Modals, dialogs, dropdowns, and toasts use correct ARIA roles via shadcn implementations wherever possible.
- No critical information is conveyed **only** through color or hover.

##### Polish & Consistency
- Loading states and skeletons exist on all major data-fetching screens (dashboard, client list, case list, invoices, reports).
- Empty states:
  - Clearly communicate "nothing here yet".
  - Offer a primary call-to-action (e.g. "Create your first client", "Create your first invoice").
- Error states:
  - Display human-friendly messages (not raw exceptions).
  - Offer a reasonable recovery action (retry, go back, contact support).
- Visual consistency across:
  - KAJ vs GCMC views
  - Dark/light mode (if applicable)
  - Desktop vs mobile breakpoints.

##### Frontend Implementation Checklist
- [ ] shadcn/ui components are used consistently for buttons, inputs, modals, toasts, dropdowns, etc.
- [ ] Tailwind utility classes follow a consistent spacing, typography, and layout system (no visually random layouts).
- [ ] All primary flows (auth, client management, cases, invoicing, tax features) are:
  - Discoverable from the main navigation
  - Intuitive to follow without external instructions.
- [ ] All modals, wizards, and forms are keyboard-accessible and screen-reader-friendly as per shadcn patterns.
- [ ] There are no obviously "unfinished" screens (misaligned content, placeholder text like "Lorem ipsum", "TODO", etc.).

---

### PHASE 7: ERROR HANDLING & LOGGING

#### 7.1 React Error Handling
- [ ] Global error boundary exists
- [ ] Error boundaries on critical sections
- [ ] User-friendly error messages

#### 7.2 API Error Handling
- [ ] Consistent error response format
- [ ] No raw stack traces in production
- [ ] Proper HTTP status codes

#### 7.3 User Feedback
- [ ] Toast/notification system exists
- [ ] Loading indicators on actions
- [ ] Success confirmations

#### 7.4 Bad Patterns
- SEARCH for empty catch blocks: `catch (e) {}`
- SEARCH for silent failures
- SEARCH for unhandled promise rejections

---

### PHASE 8: PERFORMANCE & OPTIMIZATION

#### 8.1 Database Performance
- [ ] N+1 query patterns in API routes
- [ ] Missing indexes for filtered/sorted queries
- [ ] Pagination on all list endpoints
- [ ] Select only needed columns (not SELECT *)

#### 8.2 Frontend Performance
- [ ] Lazy loading of routes/components
- [ ] React Query caching configured
- [ ] Bundle size optimization
- [ ] Image optimization

#### 8.3 Bad Patterns
- Heavy computations on main thread
- Endpoints returning too much data
- Missing query limits

---

### PHASE 9: TESTING STATUS

**Audit:** `*.test.ts`, `*.spec.ts`, `playwright.config.ts`

#### 9.1 Test Coverage
- [ ] Are critical paths tested (auth, invoicing, tax calculations)?
- [ ] What is approximate coverage percentage?

#### 9.2 Test Status
- SEARCH for `describe.skip` or `it.skip` - disabled tests
- Are integration tests running or mocked?
- Is Playwright configured for E2E?

#### 9.3 Missing Tests
- List critical business logic without tests

---

### PHASE 10: DEVOPS & DEPLOYMENT READINESS

**Audit:** `.env.example`, `docker-compose.yml`, `.github/workflows/*`

#### 10.1 Environment Configuration
- [ ] All env vars documented in .env.example
- [ ] No hardcoded secrets in code
- [ ] Separate configs for dev/staging/prod

#### 10.2 Database Operations
- [ ] Migration strategy (are migrations generated?)
- [ ] Is migration folder empty?
- [ ] Backup/restore procedures

#### 10.3 Health & Monitoring
- [ ] Health check endpoint exists
- [ ] Logging service integration
- [ ] Error tracking (Sentry, etc.)

#### 10.4 CI/CD
- [ ] Build pipeline working
- [ ] Test pipeline working
- [ ] Deployment pipeline exists

---

### PHASE 11: NOTIFICATIONS & REMINDERS

#### 11.1 Notification Systems
- [ ] Email notification service configured
- [ ] In-app notification system
- [ ] Push notifications (if mobile)

#### 11.2 Required Notifications
Check if these trigger notifications:
- [ ] Invoice due date approaching
- [ ] Tax filing deadline approaching
- [ ] Compliance certificate expiring
- [ ] Document upload completed
- [ ] Client onboarding completed
- [ ] Case status changed

#### 11.3 Email Templates
Check if these exist:
- [ ] Welcome email
- [ ] Password reset
- [ ] Email verification
- [ ] Invoice sent
- [ ] Payment received
- [ ] Deadline reminder
- [ ] User invitation

---

### PHASE 12: AUDIT TRAIL & COMPLIANCE

#### 12.1 Audit Logging
- [ ] Is there an audit_logs table?
- [ ] Are these actions logged:
  - User login/logout
  - Data creation/modification/deletion
  - Document uploads/downloads
  - Report exports
  - Permission changes

#### 12.2 Audit Visibility
- [ ] Can admins view audit history?
- [ ] Is there filtering/search on audit logs?
- [ ] Audit retention policy defined?

#### 12.3 Data Compliance
- [ ] Data export functionality (client data export)
- [ ] Data deletion capability
- [ ] Soft-delete for recovery

---

### PHASE 13: THIRD-PARTY INTEGRATIONS

#### 13.1 Current Integrations - Check Status

| Integration | Purpose | Status (Real/Mock/Missing) |
|-------------|---------|----------------------------|
| Email Service | Notifications | ? |
| File Storage | Documents | ? |
| OCR | Document scanning | ? |
| Payment Gateway | Invoice payments | ? |
| GRA API | Tax filing | ? |

#### 13.2 Integration Quality
- Are API keys managed securely?
- Are there webhook handlers?
- Is there retry logic for failures?
- Are integrations mocked in development?

---

### PHASE 14: DOCUMENTATION AUDIT

#### 14.1 Scan All Markdown Files
**Recommended command for human:**
```bash
find . -name "*.md" -type f
```

#### 14.2 Check Each File For
- **Accuracy:** Does it match current code?
- **Completeness:** Are all features documented?
- **Freshness:** Are dates/versions current?
- **Broken Links:** Do internal links work?

#### 14.3 Required Documentation
- [ ] README.md - Accurate setup guide?
- [ ] CONTRIBUTING.md - Exists?
- [ ] CHANGELOG.md - Maintained?
- [ ] API documentation
- [ ] Database schema documentation
- [ ] Deployment guide
- [ ] User guide

#### 14.4 Documentation Issues
- Docs referring to old file paths
- Screenshots showing outdated UI
- Code examples that don't work
- Wrong env var names

---

### PHASE 15: HIDDEN & CONFIG FILES

#### 15.1 .claude/ folder
- [ ] settings.json - Valid? Correct tool format (Bash(...) not bare commands)?
- [ ] CLAUDE.md - Current with project state?
- [ ] Exposed secrets?

#### 15.2 .gemini/ folder
- [ ] Configuration files current?
- [ ] Outdated context?

#### 15.3 .github/ folder
- [ ] workflows/*.yml - Working? Current Node version?
- [ ] ISSUE_TEMPLATE/ - Useful?
- [ ] PULL_REQUEST_TEMPLATE.md - Current?
- [ ] dependabot.yml - Configured?
- [ ] CODEOWNERS - Current team members?

#### 15.4 .vscode/ folder
- [ ] settings.json - Hardcoded paths?
- [ ] extensions.json - Outdated recommendations?
- [ ] launch.json - Working debug configs?

#### 15.5 .husky/ folder
- [ ] Git hooks executable?
- [ ] Hooks reference existing scripts?

#### 15.6 Root Config Files
- [ ] .env.example - Lists ALL required vars?
- [ ] .gitignore - Comprehensive?
- [ ] .eslintrc / eslint.config.js - Working?
- [ ] .prettierrc - Consistent?
- [ ] .nvmrc / .node-version - Matches package.json?
- [ ] .dockerignore - Optimized?

---

### PHASE 16: OBSOLETE & DEAD CODE

#### 16.1 Unused Dependencies
**Recommended command for human:**
```bash
npx depcheck
```

Check package.json vs actual imports.

#### 16.2 Dead Files
- Files not imported anywhere
- Backup files: *.bak, *.old, *.backup, *-copy.*
- Generated files committed by mistake
- Test files for deleted features
- Orphaned components not in any route

#### 16.3 Commented-Out Code
- SEARCH for large commented blocks (>10 lines)
- Should be removed (use git history)

#### 16.4 Debug Code
- SEARCH for: console.log, console.warn, console.error, console.debug
- Count and list locations
- Identify which should be removed vs proper logging

#### 16.5 TODO/FIXME Comments
- SEARCH for: TODO, FIXME, HACK, XXX, BUG, TEMP, TEMPORARY
- Count and categorize
- Identify obsolete vs still relevant

#### 16.6 Unused Exports
- Exported functions/components not imported anywhere

#### 16.7 Duplicate Code
- Similar code blocks that should be shared utilities

---

### PHASE 17: CONFIGURATION DRIFT

#### 17.1 Package.json Consistency
Check all package.json files:
- Root
- apps/web
- apps/server
- packages/*

Look for:
- Version mismatches of shared dependencies
- Inconsistent script names
- Missing peer dependencies
- Outdated dependencies with vulnerabilities

#### 17.2 TypeScript Config
Check all tsconfig.json files:
- Consistent compiler options?
- Strict mode enabled everywhere?
- Path aliases working?

#### 17.3 Environment Variables
- Vars used in code but not in .env.example
- Vars in .env.example but never used
- Inconsistent naming conventions

---

### PHASE 18: MOCK DATA INVENTORY (CRITICAL)

SEARCH for mock/fake data that needs real implementation.

#### 18.1 API Routes
Check `packages/api/src/routers/*.ts` for:
- Hardcoded arrays instead of database queries
- Fake/placeholder return values
- "Mock" or "Dummy" in variable names

#### 18.2 Frontend
Check `apps/web/src/components/*.tsx` for:
- Hardcoded dashboard data
- Static lists that should be dynamic
- Placeholder content

#### 18.3 Known Mock Locations (from previous audit)
- [ ] packages/api/src/routers/invoices.ts (lines 61-165)
- [ ] packages/api/src/routers/ocr.ts (lines 30-77)
- [ ] packages/api/src/routers/payroll.ts (line 165)
- [ ] packages/api/src/services/analytics-reporting.ts (lines 502-654)
- [ ] apps/web/src/components/enhanced-dashboard.tsx (lines 428-555)
- [ ] apps/web/src/components/ui/smart-search.tsx (lines 68-116)

---

### PHASE 19: SERVICE CATALOG COMPLETENESS (GAP ANALYSIS)

Compare code against the complete service list from the business PDF.

**WHERE TO LOOK FOR SERVICE DATA:**
- `packages/database/src/seed.ts` or `packages/db/src/seed.ts`
- `packages/api/src/routers/service-catalog.ts` or `services.ts`
- `apps/web/src/lib/service-catalog.ts` or similar
- Any JSON/TypeScript files in `packages/config/` or `apps/web/src/config/`
- Hardcoded arrays in components or route files
- Database schema files for service-related tables

Compare code against the complete service list from the business PDF.

#### KAJ Financial Services - ALL Services

**Tax Filing:**
- [ ] Income Tax Returns
- [ ] PAYE Returns

**Compliance Certificates:**
- [ ] Tender Compliance Certificate
- [ ] Work Permit Tax Compliance
- [ ] Land Transfer Compliance
- [ ] Liability Compliance (Firearm, etc.)
- [ ] Pension Compliance
- [ ] Certificate of Assessment

**Financial Statements:**
- [ ] Income/Expenditure Statements
- [ ] Bank Account Verification
- [ ] Cash Flow Projection
- [ ] Statements for Loans
- [ ] Statements for Investments
- [ ] Statements for Commissioner of Police (Firearm)

**Audits:**
- [ ] NGO Audit
- [ ] Co-operative Society Audit

**NIS Services:**
- [ ] NIS Registration
- [ ] NIS Contribution Schedules
- [ ] NIS Compliance Certificate
- [ ] NIS Pension Queries

#### GCMC - ALL Services

**Training:**
- [ ] HR Management Training
- [ ] Customer Relations Training
- [ ] Co-operatives & Credit Unions Training
- [ ] Organisational Management Training

**Business Development:**
- [ ] Company Incorporation
- [ ] Business Registration

**Paralegal:**
- [ ] Affidavits
- [ ] Agreement of Sales & Purchases
- [ ] Wills
- [ ] Settlement Agreement
- [ ] Separation Agreement
- [ ] Investment & Partnership Agreement

**Immigration:**
- [ ] Work Permit Application
- [ ] Citizenship Application
- [ ] Business Visa

**Business Proposals:**
- [ ] Land Occupation Proposal
- [ ] Investment Proposal
- [ ] Start-up Proposal

**Networking/Referrals:**
- [ ] Real Estate Agency Referral
- [ ] IT Services Referral
- [ ] Law Firm Referral

#### Service Metadata Requirements
For each service, check if these exist:
- [ ] Pricing (fixed or hourly)
- [ ] Required documents list
- [ ] Estimated duration
- [ ] Category/subcategory
- [ ] Business assignment
- [ ] Status (active/inactive)

---

### PHASE 20: CROSS-BUSINESS WORKFLOW SUPPORT

#### 20.1 Scenario Testing (Mental Walkthrough)

**Scenario 1: New Business Setup**
Client wants to start a business:
1. GCMC: Company Incorporation
2. GCMC: Business Registration
3. KAJ: TIN Registration
4. KAJ: VAT Registration (if applicable)
5. KAJ: NIS Employer Registration

CHECK:
- [ ] Can this be tracked as ONE engagement/project?
- [ ] Can services from both businesses be linked?
- [ ] Is there a unified timeline view?

**Scenario 2: Work Permit (Both Businesses)**
Foreign worker needs work permit:
1. GCMC: Work Permit Application (immigration)
2. KAJ: Employer Tax Compliance Certificate
3. KAJ: NIS Compliance for Employer

CHECK:
- [ ] Are these services linkable?
- [ ] Can you see all related services together?
- [ ] Does invoice show both business line items?

**Scenario 3: Annual Client Services**
Existing client annual needs:
1. KAJ: Income Tax Return
2. KAJ: PAYE Returns (monthly/quarterly)
3. KAJ: NIS Schedules (monthly)
4. GCMC: Annual Staff Training

CHECK:
- [ ] Combined invoicing possible?
- [ ] "All services for Client X this year" view?
- [ ] Cross-business revenue reporting?

#### 20.2 System Support Checklist
- [ ] Engagement/Case spanning multiple businesses
- [ ] Linked services across businesses
- [ ] Cross-business document sharing (upload once, both access)
- [ ] Unified client timeline (all activities across businesses)
- [ ] Cross-business reporting (revenue by client across all businesses)

---

### PHASE 21: EMPLOYEE PERMISSIONS

#### 21.1 Required Permission Model

**Roles:**
| Role | Access Level |
|------|-------------|
| Owner | Full access to everything |
| Admin | Full access to assigned business(es) |
| Employee | Access to assigned business(es), own cases only |
| Client Portal (future) | Client sees own documents/invoices |

**Permissions:**
- View clients (all vs assigned business)
- Create/edit clients
- View cases/engagements
- Create/edit cases
- Assign cases to self/others
- View invoices
- Create/edit invoices
- View documents
- Upload documents
- View reports (own vs all)
- Export data
- Manage employees (admin+)
- Manage services/pricing (admin+)
- Manage business settings (owner only)

#### 21.2 Audit Questions
- [ ] Can employee be assigned to multiple businesses?
- [ ] Can employee see only clients of their assigned business?
- [ ] Can cases be assigned to specific employees?
- [ ] Is there audit log of who did what?
- [ ] Can owner impersonate employee to troubleshoot?
- [ ] Are admin actions logged separately?

---

## DELIVERABLE TEMPLATE

Produce a single markdown report titled `AUDIT_FINDINGS.md` (print to console, do not save).

**START YOUR REPORT WITH THIS HEADER:**
```markdown
# GK-NEXUS AUDIT FINDINGS

**Generated by:** [CLAUDE / GEMINI]  
**Audit Date:** [YYYY-MM-DD]  
**Branch:** [branch name or "unknown"]  
**Commit:** [commit hash or "unknown"]  

---
```

The report MUST include ALL of the following sections:

---

### 1. EXECUTIVE SUMMARY

- **Audit Metadata:**
  - Audit Date: [Current date]
  - Auditing Agent: [CLAUDE / GEMINI] (whichever agent generates this report)
  - Codebase Branch: [branch name if available]
  - Commit Hash: [commit hash if available]
- Overall health score (1-10)
- Top 5 critical blockers (must fix before production)
- Top 5 quick wins (easy fixes, high impact)
- Estimated effort to production-ready (days/weeks)
- Recommended team composition for fixes
- **Current State vs Desired State Summary:** Brief overview of where the codebase is now versus where it needs to be based on business requirements

---

### 2. CURRENT STATE VS DESIRED STATE ANALYSIS

This section provides a high-level gap analysis between what exists and what's needed.

| Area | Current State | Desired State | Gap Severity |
|------|---------------|---------------|--------------|
| Client-Business Model | [Describe what exists] | Many-to-many (shared clients) | P0/P1/P2/P3 |
| Invoicing | [Describe what exists] | Cross-business line items | P0/P1/P2/P3 |
| Employee Permissions | [Describe what exists] | Multi-business assignment | P0/P1/P2/P3 |
| Service Catalog | [Describe what exists] | All KAJ + GCMC services | P0/P1/P2/P3 |
| ... | ... | ... | ... |

**Key Architectural Decisions Needed:**
- [List any major decisions that need to be made before implementation]

---

### 3. CRITICAL GAPS (Production Blockers)

Issues that MUST be fixed before any production deployment.

| ID | Issue | File(s) | Impact | Severity | Effort |
|----|-------|---------|--------|----------|--------|
| C1 | No admin seed script | packages/auth | Can't deploy fresh | CRITICAL | 2h |
| C2 | ... | ... | ... | ... | ... |

---

### 4. SECURITY VULNERABILITIES

| Severity | Issue | File:Line | Remediation |
|----------|-------|-----------|-------------|
| CRITICAL | ... | ... | ... |
| HIGH | Cookie sameSite: "none" | auth/index.ts:17 | Change to "lax" |
| HIGH | CORS empty fallback | server/index.ts:19 | Set default origin |
| MEDIUM | ... | ... | ... |
| LOW | ... | ... | ... |

---

### 5. ARCHITECTURE ISSUES

| Issue | Current State | Required State | Fix Approach | Priority |
|-------|---------------|----------------|--------------|----------|
| Client-Business relationship | One-to-One | Many-to-Many | Add join table | P0 |
| Hardcoded business names | In X files | Database-driven | Move to DB | P1 |
| ... | ... | ... | ... | ... |

---

### 6. GUYANA COMPLIANCE STATUS

| Requirement | Status | Current Value | Correct Value | File |
|-------------|--------|---------------|---------------|------|
| PAYE Bracket 1 | ✓/✗/? | | 0-130k = 0% | |
| PAYE Bracket 2 | ✓/✗/? | | 130k-260k = 25% | |
| PAYE Bracket 3 | ✓/✗/? | | 260k+ = 35% | |
| VAT Rate | ✓/✗/? | | 14% | |
| NIS Employee | ✓/✗/? | | 5.6% | |
| NIS Employer | ✓/✗/? | | 8.4% | |
| NIS Ceiling | ✓/✗/? | | $280,000/month | |

---

### 7. MOCK DATA INVENTORY

| File | Lines | Description | Real Implementation Needed |
|------|-------|-------------|---------------------------|
| invoices.ts | 61-165 | Fake invoice array | Database queries |
| ocr.ts | 30-77 | Fake OCR results | Real OCR service or remove |
| ... | ... | ... | ... |

---

### 8. SERVICE CATALOG GAP ANALYSIS

#### KAJ Services
| Service | In System? | Category Correct? | Has Pricing? | Has Documents? |
|---------|------------|-------------------|--------------|----------------|
| Income Tax Returns | ✓/✗/? | ✓/✗/? | ✓/✗/? | ✓/✗/? |
| PAYE Returns | ✓/✗/? | ✓/✗/? | ✓/✗/? | ✓/✗/? |
| Tender Compliance | ✓/✗/? | ✓/✗/? | ✓/✗/? | ✓/✗/? |
| ... | ... | ... | ... | ... |

#### GCMC Services
| Service | In System? | Category Correct? | Has Pricing? | Has Documents? |
|---------|------------|-------------------|--------------|----------------|
| Company Incorporation | ✓/✗/? | ✓/✗/? | ✓/✗/? | ✓/✗/? |
| Work Permit Application | ✓/✗/? | ✓/✗/? | ✓/✗/? | ✓/✗/? |
| ... | ... | ... | ... | ... |

---

### 9. CROSS-BUSINESS WORKFLOW GAPS

| Scenario | Supported? | Issues | Fix Needed |
|----------|------------|--------|------------|
| New Business Setup | ✓/Partial/✗ | | |
| Work Permit (both businesses) | ✓/Partial/✗ | | |
| Annual Services | ✓/Partial/✗ | | |

---

### 10. EMPLOYEE PERMISSION GAPS

| Permission | Implemented? | Issues |
|------------|--------------|--------|
| Multi-business assignment | ✓/✗/? | |
| Business-filtered views | ✓/✗/? | |
| Case assignment | ✓/✗/? | |
| Action audit logging | ✓/✗/? | |

---

### 11. FEATURE COMPLETENESS MATRIX

| Feature | Status (%) | Priority | Blocking Issues | Notes |
|---------|------------|----------|-----------------|-------|
| Authentication | 80% | P0 | Missing password reset | |
| User Management | 60% | P0 | No multi-business assign | |
| Client Management | 70% | P0 | Single business only | |
| Invoicing | 20% | P0 | All mock data | |
| Tax Calculators | 90% | P1 | Rates need verification | |
| Document Management | 50% | P1 | No expiry tracking | |
| Reporting | 30% | P2 | Mock data | |
| Notifications | 10% | P2 | No email service | |
| Audit Logs | 0% | P1 | Not implemented | |

---

### 12. DOCUMENTATION STATUS

| File | Status | Issues | Action |
|------|--------|--------|--------|
| README.md | ✓/Outdated/Missing | | |
| CONTRIBUTING.md | ✓/Outdated/Missing | | |
| API.md | ✓/Outdated/Missing | | |
| DEPLOYMENT.md | ✓/Outdated/Missing | | |
| ... | ... | ... | ... |

---

### 13. HIDDEN FOLDER AUDIT

| Folder/File | Status | Issues | Fix |
|-------------|--------|--------|-----|
| .claude/settings.json | ✓/Invalid | | |
| .github/workflows/ci.yml | ✓/Outdated | | |
| .env.example | ✓/Incomplete | | |
| ... | ... | ... | ... |

---

### 14. OBSOLETE CODE INVENTORY

#### Files to Delete
| File | Reason |
|------|--------|
| path/to/file.bak | Backup file |
| path/to/old-component.tsx | Not imported |
| ... | ... |

#### Dependencies to Remove
| Package | Reason |
|---------|--------|
| unused-package | Not imported |
| ... | ... |

#### Code Blocks to Remove
| File | Lines | Reason |
|------|-------|--------|
| main.tsx | 9,66,68,83,85,89,93,96,98,107,110 | console.log statements |
| ... | ... | ... |

#### TODOs to Address
| File | Line | Comment | Status | Action |
|------|------|---------|--------|--------|
| api.ts | 45 | // TODO: Add validation | Stale/Active | Implement or remove |
| ... | ... | ... | ... | ... |

---

### 15. CONFIGURATION FIXES NEEDED

| Config File | Issue | Current | Should Be |
|-------------|-------|---------|-----------|
| .nvmrc | Wrong Node | 16 | 20 |
| tsconfig.json | Strict off | false | true |
| package.json | Version mismatch | react 18.2.0 | Consistent everywhere |
| ... | ... | ... | ... |

---

### 16. TECH DEBT INVENTORY

| File | Issue | Impact | Suggested Fix | Priority |
|------|-------|--------|---------------|----------|
| | Duplicate code | Maintenance | Extract utility | P2 |
| | Large file (700+ lines) | Readability | Split into modules | P3 |
| ... | ... | ... | ... | ... |

---

### 17. RECOMMENDED IMPLEMENTATION ORDER

Prioritized by: Security → Data Integrity → Core Features → Compliance → Polish

| Order | Task | Priority | Effort | Dependencies |
|-------|------|----------|--------|--------------|
| 1 | Fix security vulnerabilities (cookies, CORS) | P0 | 2h | None |
| 2 | Create missing database schemas (invoices, audit) | P0 | 4h | None |
| 3 | Fix Client-Business many-to-many | P0 | 4h | Schema |
| 4 | Replace mock data with real DB queries | P0 | 8h | Schemas |
| 5 | Add employee multi-business assignment | P0 | 4h | Schema |
| 6 | Complete service catalog (all KAJ + GCMC) | P1 | 4h | None |
| 7 | Implement cross-business case linking | P1 | 6h | Schema |
| 8 | Verify Guyana tax rates | P1 | 2h | None |
| 9 | Add audit logging | P1 | 4h | Schema |
| 10 | Set up email notifications | P2 | 6h | Service setup |
| 11 | Remove obsolete code | P2 | 2h | None |
| 12 | Update documentation | P3 | 4h | After fixes |

---

### 18. RECOMMENDED VERIFICATION COMMANDS

Commands for the human to run after implementing fixes:

```bash
# Type checking
bun run check-types

# Linting
bun run lint

# Build
bun run build

# Database migrations
bun run db:generate
bun run db:migrate

# Test database connection
bun run db:studio

# Run tests
bun run test

# Check for unused dependencies
npx depcheck

# Check for security vulnerabilities
npm audit

# Verify CORS headers
curl -I http://localhost:3000
```

---

### 19. NEXT ACTIONS (FOR HUMAN)

Top 5-10 concrete next steps:

1. ...
2. ...
3. ...
4. ...
5. ...

---

### 20. THE CLAUDE CODE MASTER PROMPT

Below is a comprehensive, copy-paste ready prompt for Claude Code to implement ALL fixes.

```
You are fixing GK-Nexus, a unified business management platform for KAJ Financial Services and GCMC in Guyana.

## CRITICAL CONTEXT

[Include the full business context from the audit]

## IMPLEMENTATION PHASES

### PHASE 1: SECURITY FIXES (Do First - Estimated: 2 hours)

#### 1.1 Fix Cookie Security
File: packages/auth/src/index.ts

```typescript
// BEFORE
sameSite: "none"

// AFTER
sameSite: "lax",
secure: process.env.NODE_ENV === "production",
httpOnly: true,
```

#### 1.2 Fix CORS
File: apps/server/src/index.ts

```typescript
// BEFORE
origin: process.env.CORS_ORIGIN || ""

// AFTER
origin: process.env.CORS_ORIGIN || "http://localhost:3001",
```

[Continue with ALL specific fixes, file paths, line numbers, before/after code...]

### PHASE 2: DATABASE SCHEMAS (Estimated: 4 hours)

[Specific schema definitions...]

### PHASE 3: REPLACE MOCK DATA (Estimated: 8 hours)

[Specific file changes...]

[... Continue for ALL phases ...]

## VERIFICATION AFTER EACH PHASE

After Phase 1:
```bash
bun run check-types
# Manually verify: Check CORS headers
```

After Phase 2:
```bash
bun run db:generate
bun run db:migrate
# Manually verify: Open db:studio and check tables
```

[... Continue verification steps ...]

## COMPLETION CHECKLIST

- [ ] All security vulnerabilities fixed
- [ ] All database schemas created
- [ ] All mock data replaced
- [ ] Service catalog complete (all KAJ + GCMC services)
- [ ] Cross-business workflows working
- [ ] Employee permissions working
- [ ] Tax rates verified against GRA 2025
- [ ] Audit logging implemented
- [ ] Documentation updated
- [ ] All tests passing
- [ ] No TypeScript errors
- [ ] No console.log statements in production code
```

---

## END OF AUDIT PROMPT

**START THE AUDIT NOW.**

Be thorough and systematic. Follow the Global Rules. Use the Result Markers consistently. This audit will be the foundation for bringing GK-Nexus to production.
