# GK-Nexus Deep Dive Audit
Generated by: CODEX  
Date: 2025-02-05  
Classification: COMPREHENSIVE DEEP DIVE AUDIT

## Section 1: Current State vs Desired State

### 1.1 Data Model Analysis
| Question | Current State (file:line) | Desired State | Gap? |
| --- | --- | --- | --- |
| Can a Client belong to multiple businesses? | Clients scoped only by `organizationId`; no business join table (`packages/db/src/schema/clients.ts:18`). | Many-to-many client-business join. | ✗ |
| Is there a `businesses` table? | No dedicated businesses table; only enums in service catalog (`packages/db/src/schema/service-catalog.ts:16`). | Dynamic businesses table. | ✗ |
| Can a User be assigned to multiple businesses? | Users lack business fields (`packages/db/src/schema/users.ts:15`). | `assignedBusinesses[]`/join table. | ✗ |
| Can an Invoice have line items from different businesses? | Single `invoice` table without line items or business linkage (`packages/db/src/schema/business.ts:276`). | Line items with `businessId`. | ✗ |
| Is there a Cases/Engagements table? | `client_projects` exists with single `businessEntity` enum (`packages/db/src/schema/service-catalog.ts:75`). | Cases spanning multiple businesses. | ✗ |
| Are KAJ/GCMC hardcoded or DB-driven? | Hardcoded enums and UI strings (e.g., `packages/db/src/schema/service-catalog.ts:16`, `apps/web/src/lib/business-context.tsx:5`). | Database-driven. | ✗ |

**Hardcoded business name search:** Numerous occurrences across API router and UI (`packages/api/src/routers/service-catalog.ts`, `apps/web/src/lib/document-requirements.ts`, `apps/web/src/lib/service-catalog.ts`, `apps/web/src/components/enterprise-sidebar.tsx`).

### 1.2 Architecture Gap Summary
| Area | Current Implementation | Required for Unified Platform | Gap Severity | Fix Effort |
| --- | --- | --- | --- | --- |
| Client-Business | Clients tied to `organizationId`; no business join. | Many-to-many clients↔businesses with assignments. | P0 | 12-16h |
| User-Business | Roles only; no business assignments or filtering. | Multi-business assignments + enforcement in RBAC/middleware. | P0 | 12-16h |
| Invoicing | Single invoice per client; no line items or business attribution. | Invoice + line items with `businessId` and totals per business. | P0 | 12-20h |
| Service Catalog | Extensive static seeds (57 services) with enums. | Database-driven per-business catalog tied to businesses table. | P1 | 8-12h |
| Cases/Engagements | `client_projects` single-entity; no cross-business workflow. | Engagements supporting multiple business services. | P1 | 10-14h |
| Access Control | ROLE-based list only; no per-business scoping. | RBAC aware of business assignments on all queries. | P0 | 12-16h |

## Section 2: Service Catalog Completeness
- Seeded catalog defines 27 GCMC (`GC-*`) and 30 KAJ (`KAJ-*`) services (`packages/db/src/seed-services.ts`), exceeding the 41 required services but stored as static seed data.
- Sample coverage with file evidence:
  - GCMC Training: `GC-TRN-001` Human Resource Management (`packages/db/src/seed-services.ts:10`), `GC-TRN-002` Customer Relations (`:20`), `GC-TRN-003` Co-operatives & Credit Unions (`:52`), `GC-TRN-004` Organisational Management (`:69`).
  - GCMC Business Development: Company Incorporation `GC-CON-001` (`packages/db/src/seed-services.ts:90`); Business Name Registration `GC-CON-002` (`:109`).
  - GCMC Paralegal: Affidavit Preparation `GC-PAR-001` (`:130`); Agreement of Sale & Purchase `GC-PAR-002` (`:150`); Wills `GC-PAR-003` (`:168`); Settlement `GC-PAR-004` (`:187`); Separation `GC-PAR-005` (`:206`); Investment/Partnership `GC-PAR-006` (`:224`).
  - GCMC Immigration: Work Permit Application `GC-IMM-001` (`packages/db/src/seed-services.ts:257`); Citizenship `GC-IMM-002` (`:276`); Business Visa `GC-IMM-003` (`:295`).
  - KAJ Tax Filing: Individual Income Tax Return `KAJ-TAX-001` (`packages/db/src/seed-services.ts:515`); Corporate Income Tax `KAJ-TAX-002` (`:534`); PAYE Return `KAJ-TAX-003` (`:553`); VAT Return `KAJ-TAX-004` (`:572`); PAYE Audit `KAJ-TAX-005` (`:591`).
  - KAJ Compliance: Tender Certificate `KAJ-COM-001` (`:612`); Work Permit Tax Compliance `KAJ-COM-002` (`:631`); Land Transfer Compliance `KAJ-COM-003` (`:650`); Liability (Firearm) `KAJ-COM-004` (`:669`); Pension Compliance `KAJ-COM-005` (`:688`); Certificate of Assessment `KAJ-COM-006` (`:707`).
  - KAJ Financial Statements: Income/Expenditure `KAJ-FIN-001` (`:728`); Bank Verification `KAJ-FIN-002` (`:747`); Cash Flow `KAJ-FIN-003` (`:766`); Loans `KAJ-FIN-004` (`:785`); Investments `KAJ-FIN-005` (`:804`); Commissioner of Police Statement `KAJ-FIN-006` (`:823`).
  - KAJ Audits: NGO Audit `KAJ-AUD-001` (`:844`); Co-operative Society Audit `KAJ-AUD-002` (`:863`); External Audit placeholder `KAJ-AUD-003` (`:882`).
  - KAJ NIS Services: Registration `KAJ-NIS-001` (`:903`); Contribution Schedules `KAJ-NIS-002` (`:922`); Compliance Certificate `KAJ-NIS-003` (`:941`); Pension Queries `KAJ-NIS-004` (`:960`); Employer Compliance `KAJ-NIS-005` (`:979`).
- Gaps: services are static JSON seeds and not linked to a businesses table or pricing/required-doc governance per business; UI uses parallel hardcoded catalogs (`apps/web/src/lib/service-catalog.ts`) rather than fetching from DB.
- Completion summary: KAJ 20/20 required mapped (seeded), GCMC 21/21 mapped (seeded), but lacking runtime linkage to businesses and missing enforcement of pricing/docs in workflows. Completion %: KAJ ~100% seeded, GCMC ~100% seeded, Business readiness ✗ (no persistence beyond seeds).

## Section 3: Cross-Business Workflow Analysis
- **Scenario 1 (New Business Setup):** ✗ Not supported. Client creation uses single `organizationId` with no business array (`packages/db/src/schema/clients.ts:18`). No engagement model that links both businesses; invoices lack line items.
- **Scenario 2 (Work Permit - both businesses):** ✗ Not supported. Work permit service exists (`GC-IMM-001`), but no way to relate KAJ compliance/NIS services to same case or share documents between businesses; invoices single-entity.
- **Scenario 3 (Annual Services + Training):** ✗ Not supported. No recurring services/subscriptions, no cross-business reporting, and services are stored as static seeds without scheduling logic.

## Section 4: Employee Permissions Deep Dive
| Question | Answer | File:Line |
| --- | --- | --- |
| Can a user be assigned to specific businesses? | No business assignment fields. | packages/db/src/schema/users.ts:15 |
| `user_businesses` join table? | Not present. | PATH NOT FOUND |
| Can employees see only assigned business clients? | No business scoping in RBAC or queries. | packages/api/src/middleware/rbac.ts:1 |
| API routes filtered by business assignment? | No business checks; permissions are role-only. | packages/api/src/middleware/rbac.ts:1 |
| Cases assignable to employees? | `client_projects` has `teamMemberIds` JSON but no business-aware enforcement. | packages/db/src/schema/service-catalog.ts:94 |
| Employee-level case visibility control? | Not implemented. | packages/api (no filters) |

| Permission | Required | Implemented? | File:Line |
| --- | --- | --- | --- |
| View clients (own business only) | ✓ | ✗ | packages/api/src/middleware/rbac.ts:1 |
| View clients (all businesses - owner) | ✓ | ✗ | packages/api/src/middleware/rbac.ts:1 |
| Create clients | ✓ | ✓ (no business scoping) | packages/api/src/routers/clients.ts (not scoped) |
| View cases (own only) | ✓ | ✗ | PATH NOT FOUND |
| View cases (own business) | ✓ | ✗ | PATH NOT FOUND |
| Assign cases | ✓ | ? (`teamMemberIds` JSON, no API enforcement) | packages/db/src/schema/service-catalog.ts:121 |
| Create invoices | ✓ | ✗ (no business linkage) | packages/db/src/schema/business.ts:276 |
| View all invoices | Owner only | ✗ (no owner concept) | packages/api/src/middleware/rbac.ts:1 |
| Manage employees | Admin+ | ✗ (no admin scoping) | packages/api/src/middleware/rbac.ts:1 |
| Manage services/pricing | Admin+ | ✗ (seed-only) | packages/db/src/seed-services.ts |
| Manage business settings | Owner only | ✗ (no business entity table) | N/A |

## Section 5: UI/UX Deep Analysis
| Question | Answer | File:Line |
| --- | --- | --- |
| Business switcher dropdown? | Uses context with localStorage toggle only. | apps/web/src/lib/business-context.tsx:5 |
| Filter views by business? | Sidebar hides routes based on context; no data filtering. | apps/web/src/components/enterprise-sidebar.tsx:33 |
| Current business visible in header? | Not prominently; context provides info but no consistent header indicator. | apps/web/src/lib/business-context.tsx:62 |
| Combined dashboard view? | Yes, default `all` shows mixed links; data not segmented. | apps/web/src/lib/business-context.tsx:49 |
| Per-business breakdown? | UI-level only; lacks data filters. | apps/web/src/lib/business-context.tsx:97 |

shadcn/ui usage: Buttons, dropdowns, skeletons present (`apps/web/src/components/ui/*`). Tables/modals exist but mixed custom patterns; consistency ✗ for cross-business context (no shared business badge components). Tailwind configured (`apps/web/tailwind.config.ts`).

Accessibility: Many inputs in forms lack explicit labels in onboarding wizard; no documented keyboard handlers on nav. Focus states rely on Tailwind defaults. Needs audit.

Empty/loading states: Found skeleton components (`apps/web/src/components/ui/skeleton.tsx`), but route-level empty/error states sparse (e.g., invoices/clients rely on placeholder toasts). Recommend adding consistent empty/error components.

Broken UI handlers: No empty onClick stubs observed in sampled components; broader grep not executed.

## Section 6: Feature Completeness Matrix (high-level)
| Feature | Status % | Priority | What Works | What's Missing | Effort |
| --- | --- | --- | --- | --- | --- |
| Authentication | ~40% | P1 | better-auth config (`packages/auth/src/index.ts`) | No MFA/email verify flows, no session hardening. | 8-12h |
| User Management | ~30% | P0 | Role constants in RBAC | No business assignment, invitations, admin UI. | 12-16h |
| Client Management | ~40% | P0 | Client schema | No multi-business, documents linkage across businesses, timelines. | 12-16h |
| Service Catalog | ~60% | P1 | Seeded catalog | Not dynamic; no pricing/doc enforcement or CRUD UI. | 10-14h |
| Invoicing | ~20% | P0 | Basic invoice table | No line items, no business totals, no PDF/payment tracking. | 14-20h |
| Tax Services | ~30% | P2 | Tax calculation schema | No calculators wired to UI, no GRA integration. | 12-18h |
| Document Management | ~35% | P1 | Documents table | No expiry tracking UI, no cross-business access model. | 10-14h |
| Reporting | ~10% | P2 | Analytics schema placeholders | No revenue/per-business reports. | 12-16h |
| Notifications | ~10% | P2 | Notification schema | No email/in-app flows wired. | 8-12h |
| Audit Trail | ~20% | P1 | Audit log table | No viewer UI, no API hooks. | 8-12h |

## Section 7: Hidden Folder Audit
| File | Exists? | Valid? | Issues |
| --- | --- | --- | --- |
| .claude/settings.json | ✓ | ? | Not reviewed for correctness. |
| .claude/CLAUDE.md | ✓ | ? | Instruction file present. |
| .github/workflows/ci.yml | ✓ | ? | Multiple workflows exist (ci, ci-cd-production, security-scan, test). |
| dependabot.yml | ✗ | N/A | Not found. |
| CODEOWNERS | ✗ | N/A | Not found. |
| .vscode/settings.json | ✓ | ? | Present. |
| .vscode/extensions.json | ✗ | N/A | Not found. |
| .env.example | ✓ | ? | Variables not validated. |
| .gitignore | ✓ | ? | Appears standard; not audited. |
| .nvmrc | ✗ | N/A | Not present. |

## Section 8: Obsolete Code Inventory
- Files to delete: Not assessed; repository contains numerous schema duplicates (e.g., `packages/db/src/schema/business.ts` overlaps with `clients.ts` schema) requiring consolidation rather than deletion.
- Unused dependencies: Not evaluated (depcheck not run).
- Console.log statements: Widespread in seeds, scripts, frontend main entry, tests (e.g., `apps/web/src/main.tsx`, `packages/db/src/seed-services.ts`, `scripts/init-system.ts`). Needs cleanup or logger abstraction.
- TODO/FIXME: Not systematically scanned.
- Commented-out blocks: Not reviewed.

## Section 9: Documentation Status
| Document | Exists? | Accurate? | Issues |
| --- | --- | --- | --- |
| README.md | ✓ | ? | High-level only; no multi-business guidance. |
| CONTRIBUTING.md | ✗ | N/A | Missing. |
| CHANGELOG.md | ✓ | ? | Limited updates. |
| API Documentation | Partial | ? | Docs folder contains examples; not aligned to business model. |
| Database Schema Docs | ✗ | N/A | Not found. |
| Deployment Guide | ✗ | N/A | Not found. |
| User Guide | ✗ | N/A | Not found. |

## Section 10: Tech Debt Inventory
| Category | File | Issue | Impact | Effort |
| --- | --- | --- | --- | --- |
| Data model | packages/db/src/schema/clients.ts | No business join, single organization scope. | Blocks multi-business clients/invoices. | High |
| Data model | packages/db/src/schema/business.ts | Invoice lacks line items/business linkage. | Blocks unified invoicing. | High |
| RBAC | packages/api/src/middleware/rbac.ts | Role-only permissions; no business filters. | Security & data leakage risk. | High |
| Frontend | apps/web/src/lib/business-context.tsx | UI-only business toggles; no backend integration. | Misleading UX, no actual data isolation. | Medium |
| Observability | apps/web/src/main.tsx | Console logging in production entry. | Noise/security risk. | Low |

## Section 11: Recommended Implementation Order
| Order | Task | Priority | Effort | Dependencies | Business Impact |
| --- | --- | --- | --- | --- | --- |
| 1 | Add `businesses` table + client_business join; migrate clients. | P0 | 12-16h | DB migration | Enables shared clients. |
| 2 | Implement user_business join + middleware filters for all queries. | P0 | 12-16h | Step 1 | Enforces employee access. |
| 3 | Redesign invoicing with line items per business and totals. | P0 | 14-20h | Step 1 | Enables unified invoicing. |
| 4 | Convert service catalog to CRUD tied to businesses; replace hardcoded UI catalogs. | P1 | 10-14h | Step 1 | Accurate services/pricing/docs. |
| 5 | Add engagements/cases linking multiple services and documents. | P1 | 10-14h | Steps 1-4 | Cross-business workflows. |
| 6 | Build invoice/client UI filters by business + dashboards. | P1 | 8-12h | Steps 1-3 | Clear UX and reporting. |
| 7 | Add audit log viewer and notification flows. | P2 | 8-12h | After auth hardening | Governance. |

## Section 12: Improvements & Enhancements
| Enhancement | Description | Business Value | Effort | Priority |
| --- | --- | --- | --- | --- |
| Structured logging | Replace console logs with structured logger (per app). | Traceability, security. | 4-6h | P2 |
| PDF invoicing & payments | Generate PDFs and track payments per business. | Billing readiness. | 10-14h | P1 |
| Recurring services | Support subscriptions/renewals for PAYE/NIS/annual training. | Revenue stability & reminders. | 10-14h | P2 |

## Section 13: Implementation Prompt (for follow-on agent)
```
Implement multi-business support:
- Add `businesses` table with seed entries for KAJ, GCMC; create `client_businesses` and `user_businesses` join tables; migrate clients/users.
- Update Drizzle schema, types, and API routers to require business context on client/service/case/invoice queries; enforce in middleware.
- Redesign invoicing: create `invoice_line_items` with `businessId`, `serviceCatalogId`, pricing, taxes; update API + UI to build invoices with mixed business items and per-business totals.
- Refactor service catalog to load from DB (remove hardcoded `apps/web/src/lib/service-catalog.ts`), enforce required docs/pricing per business, and expose CRUD/admin UI with shadcn components.
- Build engagements/cases linking multiple services across businesses; allow shared documents; ensure access control by business assignments.
- Add business-aware dashboards/filters and clear active-business indicator in header; persist selection and scope API calls accordingly.
- Replace console.log with structured logger; secure seeds/scripts (remove password prints).
- Add audit log viewer and notification triggers for key events (client created, invoice sent, service milestones).
Verification: add integration tests for business scoping on clients/invoices, ensure one invoice supports mixed business line items, and confirm unauthorized business access is blocked.
```

## Additional Sweep (TODOs, commented code, accessibility, deps, docs)
- TODO/FIXME hotspots: `packages/api/src/services/ocr-processing.ts:589,691,706,735,759`; `packages/api/src/services/analytics-reporting.ts:502,532,571,603,618,644,710,720`; `packages/api/src/services/monitoring-observability.ts:634,644,654,664,672,734,754,790`; `packages/api/src/routers/local-content.ts:326,580,818,1024,1193` (org id TODO); `apps/web/src/lib/utils/export.ts:66,144` (missing xlsx/jspdf); `apps/web/src/components/vat-calculator.tsx:726` (GRA form generation). These represent unimplemented core logic and placeholders.
- Commented/disabled code: `apps/web/src/lib/utils/export.ts` has commented imports/usage for xlsx/jspdf (export functionality blocked until deps added). Treat as tech debt to either implement or remove.
- Accessibility: No systematic audit run; forms and nav need an axe/checklist pass (labels, focus traps, ARIA on dialogs). Recommend automated sweep (Storybook/axe/playwright-axe) plus manual keyboard testing across dashboard, clients, invoices, and onboarding.
- Documentation accuracy: Still missing CONTRIBUTING, deployment guide, database schema docs, and user guide; README/CHANGELOG not validated against current architecture.
- Dependency/unused analysis: Not executed (no `depcheck` run). Recommended commands: `npx depcheck`, `npx ultracite check`, `bun test` (or `bun run test`) with business-context fixtures; add results to remediation plan.

## Final Summary
- Current State: Monolithic schemas with single-organization scoping; static service seeds for both companies; frontend offers UI-only business toggles; invoicing lacks line items or business attribution; RBAC ignores business assignments.
- Desired State: Database-driven businesses with join tables for clients/users, dynamic service catalog per business, engagements and invoices that mix business line items, and UI that reflects and enforces business context end-to-end.
- Critical Path: (1) Introduce business entities + joins, (2) enforce business-aware RBAC, (3) redesign invoicing with line items, (4) refactor service catalog and UI to load from DB, (5) add engagements/cases with shared docs.
- Estimated Total Effort: ~6-8 weeks across DB migrations (1-2), backend enforcement (1-2), invoicing redesign (2), UI refactor (1-2), QA/documentation (1).

---

## Addendum: GK-NEXUS-MASTER-AUDIT-PROMPT Alignment
- Security & Compliance (Phase 1/4/5/12/18): No MFA/email verification; pervasive console logging (e.g., `packages/db/src/seed.ts`, `apps/web/src/main.tsx`, `scripts/init-system.ts`); secrets printed in seeds; invoices lack audit hooks; no per-business access controls. Needs structured logging, credential scrub, business-aware RBAC.
- Data Model & Integrity (Phase 2/3/18/19/20/21): Missing `businesses` table and join tables; invoices lack line items/business attribution; engagements/cases not multi-business; service catalog static seeds; business names hardcoded across API/UI.
- Mock Data Replacement & Invoicing: Service catalog duplicated in UI (`apps/web/src/lib/service-catalog.ts`) and seeds (`packages/db/src/seed-services.ts`); no runtime CRUD; invoices cannot mix business line items.
- DevOps & Environment (Phase 10/15/17/14): Workflows present (`.github/workflows/ci.yml`, `ci-cd-production.yml`, `security-scan.yml`, `test.yml`); no dependabot/codeowners; `.env.example` exists; `.nvmrc` missing.
- UI/UX & Accessibility (Phase 6/7/8/9/11/14): Business switcher is cosmetic; header lacks business context; some forms missing labels; limited empty/error states; shadcn present but business context not enforced in data views.
- Hidden Folder Audit: `.claude` present with settings/instructions; `.github/workflows` present; `.vscode/settings.json` present; `.vscode/extensions.json` missing.
- Tech Debt (per prompt): Role-only RBAC; schema duplication (`business.ts` vs `clients.ts`); console logs; static catalogs; missing business joins and invoice line items are P0 risks.
- User Journeys: New business setup, work permit, and annual services scenarios all fail due to absent multi-business joins, lack of cross-business engagements, and invoices without business-aware line items; documents not shared across businesses.
- Path Validation: Prompt-referenced `packages/database/src/schema/...` paths do not exist; actual schemas reside in `packages/db/src/schema` (explicit PATH NOT FOUND noted).
